---
title: "Orthogonal Procrustes Analysis with anisotropic scaling"
collection: software
type: "Matlab Code"
permalink: /software/2020_AOPA_major
date: 2020-08-24
---

The following matlab code implements an iterative solution to solve the Orthogonal Procrustes Analysis problem with anisotropic scaling. The mathematical foundation was initially presented in [[1]](#1) in which a Majorization Principle was applied to derived the solution. It has guaranteed convergence. I presented the psudo/matlab code in [[2]](#2) in the context of ultrasound probe calibration.

``` matlab
function [ R, t, A ] = AOPA( X, Y, tol ) 
% Solves   Y = R A X + t
% INPUTS:  X : (mxn) mD coordinates,
%          Y : (mxn) mD coordinates
%        tol : exit condition (1e-6)
% OUTPUTS: R : mxm orthonormal rotation
%          t : mx1 translation
%          A : mxm diagonal scaling
%
% Elvis C.S. Chen
% Aug. 24, 2020
[m, n]=size(X); e=ones(n,1); II=eye(n)-((e*e')./n);  
mX  = normr(X*II); mX(isnan(mX)) = 0; mY = (Y*II); 
B   = mY*mX'; [U,~,V] = svd( B ); 
D   = eye(m); D(m,m) = det(U*V'); R = U*D*V';
err = +Inf; E_old = 10000*ones(m,n);
while err > tol                                     
  [U,~,V] = svd( B*diag(diag(R'*B)) ); 
  D(m,m) = det(U*V'); R = U*D*V';  
  E = R*mX-mY; err = norm(E-E_old,'fro'); E_old = E;
end
B = Y*II*X'; A = diag( diag(B'*R)./diag(X*II*X') ); 
t = mean( Y-R*A*X, 2); 
```

The code above is optimize for length, not necessary for computational efficiency. Note that if an initial estimate of rotation is known, it can be used for initialization (right before the loop begins).

If you decide to use this code, please consider citing [[2]](#2).

## References
<a id="1">[1]</a>
Bennani Dosse, M., & Ten Berge, J. (2010). 
Anisotropic Orthogonal Procrustes Analysis. 
Journal of Classification, 27(1), 111â€“128. 
[https://doi.org/10.1007/s00357-010-9046-8](https://doi.org/10.1007/s00357-010-9046-8)

<a id="2">[2]</a>
Chen, E. C. S., McLeod, A. J., Jayarathne, U. L., & Peters, T. M. (2014). 
Solving for free-hand and real-time 3D ultrasound calibration with anisotropic orthogonal Procrustes analysis.
In Z. R. Yaniv & D. R. Holmes (Eds.), 
Proc. SPIE 9036, Medical Imaging 2014: Image-Guided Procedures, Robotic Interventions, and Modeling (p. 90361Z). 
San diego, California, United States. 
[https://doi.org/10.1117/12.2043080](https://doi.org/10.1117/12.2043080)